/* SmartStudy Companion – minimal working baseline
   - Local-only processing
   - Upload: PDF/TXT/HTML/Images or ZIP (auto-unpack)
   - Simple subject/chapter heuristics
   - Quick/Detailed summaries
   - MCQ quiz generator
   - Read aloud with Indian voices (en-IN / hi-IN / mr-IN)
*/

(() => {
  // ---------- state ----------
  const state = {
    student: localStorage.getItem('ssc_student') || '',
    collection: localStorage.getItem('ssc_collection') || 'CBSE Class 10',
    voiceLang: localStorage.getItem('ssc_voice') || 'en-IN',
    items: loadJSON('ssc_items', []), // [{id, title, subject, chapter, pages, text}]
    voices: [],
    selectionIndex: null, // selected row
  };

  // ---------- helpers ----------
  function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
  function loadJSON(key, fallback) {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  }
  const $ = sel => document.querySelector(sel);
  function speak(text) {
    if (!window.speechSynthesis) return alert('Speech Synthesis not supported in this browser.');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = state.voiceLang;
    // prefer an Indian voice
    const match = state.voices.find(v => v.lang === state.voiceLang) ||
                  state.voices.find(v => v.lang.startsWith(state.voiceLang.split('-')[0]));
    if (match) u.voice = match;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // very small heuristics for subject/chapter from text
  function guessSubject(text) {
    const s = text.toLowerCase();
    if (/(physics|force|motion|electric|magnet)/.test(s)) return 'Science';
    if (/(chemistry|acid|base|salt|metal|non-metal)/.test(s)) return 'Science';
    if (/(biology|cell|life|reproduction|ecosystem)/.test(s)) return 'Science';
    if (/(math|algebra|geometry|trigonometry|probability)/.test(s)) return 'Mathematics';
    if (/(history|geography|civics|economics|polity|democracy)/.test(s)) return 'Social Science';
    if (/(hindi|kavita|vyakaran|gadyansh)/.test(s)) return 'Hindi';
    if (/(marathi|abhyaas|vyakaran|kavita)/.test(s)) return 'Marathi';
    if (/(english|prose|poem|grammar|comprehension)/.test(s)) return 'English';
    return 'General';
  }
  function guessChapter(text) {
    const m = text.match(/\b(chapter|lesson|unit)\s*[:\-]?\s*(\d+)\b/i);
    if (m) return `${m[1]} ${m[2]}`;
    const h = text.match(/\n\s*([A-Z][^\n]{5,60})\n/); // first heading-like line
    return h ? h[1].trim().slice(0, 70) : 'Overview';
  }

  function cleanText(t) {
    return (t||'')
      .replace(/\r/g,' ')
      .replace(/\u00A0/g,' ')
      .replace(/[ \t]+/g,' ')
      .replace(/\n{2,}/g,'\n')
      .trim();
  }

  // ---------- PDF/TXT/HTML extraction ----------
  async function extractFromPDF(file) {
    const buf = await file.arrayBuffer();
    const doc = await pdfjsLib.getDocument({ data: buf }).promise;
    let text = '';
    for (let p=1; p<=doc.numPages; p++) {
      const page = await doc.getPage(p);
      const content = await page.getTextContent();
      const line = content.items.map(it => it.str).join(' ');
      text += line + '\n';
    }
    return { text: cleanText(text), pages: doc.numPages };
  }
  async function extractFromTXT(file) {
    const text = await file.text();
    return { text: cleanText(text), pages: Math.max(1, Math.ceil(text.length/1200)) };
  }
  async function extractFromHTML(file) {
    const html = await file.text();
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const text = cleanText(tmp.innerText || tmp.textContent || '');
    return { text, pages: Math.max(1, Math.ceil(text.length/1600)) };
  }
  async function extractFromImage(file) {
    // placeholder: real OCR would need an OCR library; store filename only
    return { text: file.name.replace(/\.[^.]+$/,''), pages: 1 };
  }

  // ---------- ZIP handling ----------
  async function handleZip(file) {
    const zip = await JSZip.loadAsync(await file.arrayBuffer());
    const adds = [];
    for (const path in zip.files) {
      const entry = zip.files[path];
      if (entry.dir) continue;
      const lower = path.toLowerCase();
      const blob = await entry.async('blob');
      const inner = new File([blob], path.split('/').pop(), { type: blob.type });
      adds.push(await routeFile(inner));
    }
    return adds.flat();
  }

  // route by type; returns array of items
  async function routeFile(file) {
    const name = file.name || 'file';
    const lower = name.toLowerCase();
    try {
      if (lower.endsWith('.zip')) {
        return await handleZip(file);
      }
      let info;
      if (lower.endsWith('.pdf')) info = await extractFromPDF(file);
      else if (/\.(txt|md)$/.test(lower)) info = await extractFromTXT(file);
      else if (/\.(html|htm)$/.test(lower)) info = await extractFromHTML(file);
      else if (/\.(png|jpg|jpeg)$/.test(lower)) info = await extractFromImage(file);
      else return []; // skip unknowns

      const subj = guessSubject(info.text);
      const chap = guessChapter(info.text);
      const item = {
        id: crypto.randomUUID(),
        title: name.replace(/\.[^.]+$/,''),
        subject: subj,
        chapter: chap,
        pages: info.pages,
        text: info.text.slice(0, 2_000_000) // safety cap
      };
      return [item];
    } catch (e) {
      console.error('Error reading', name, e);
      return [];
    }
  }

  // ---------- rendering ----------
  function renderLib() {
    $('#libCollection').textContent = state.collection;
    const tbody = $('#libBody');
    tbody.innerHTML = '';
    state.items.forEach((it, idx) => {
      const tr = document.createElement('tr');
      if (idx === state.selectionIndex) tr.style.background = '#0c1322';
      tr.innerHTML =
        `<td>${it.subject}</td><td>${it.chapter}</td><td>${it.title}</td><td>${it.pages}</td>`;
      tr.addEventListener('click', () => {
        state.selectionIndex = (state.selectionIndex === idx ? null : idx);
        renderLib();
      });
      tbody.appendChild(tr);
    });
  }

  // ---------- summarizers ----------
  function splitSentences(t) {
    return t.replace(/\s+/g,' ')
            .split(/(?<=[\.\?\!])\s+/)
            .map(s => s.trim())
            .filter(Boolean);
  }
  function summaryQuick(text) {
    const sents = splitSentences(text);
    const picks = [];
    const kw = /(important|main|therefore|thus|because|consists|includes|causes?|effects?|definition|defined|mean|is called)/i;
    for (const s of sents) if (kw.test(s)) picks.push('• '+s);
    if (picks.length < 5) {
      // fall back: take first N reasonable sentences
      picks.push(...sents.slice(0, 5 - picks.length).map(s => '• '+s));
    }
    return picks.slice(0, 10).join('\n');
  }
  function summaryDetailed(text) {
    const lines = text.split('\n');
    const bullets = [];
    for (const ln of lines) {
      if (/^\s*[\-\*\u2022]/.test(ln)) bullets.push('• '+ln.replace(/^\s*[\-\*\u2022]\s*/,''));
      else if (/^[A-Z][A-Za-z0-9\s]{4,60}$/.test(ln)) bullets.push('◼︎ '+ln.trim());
    }
    if (bullets.length < 8) bullets.push(...summaryQuick(text).split('\n'));
    return bullets.slice(0, 24).join('\n');
  }

  // ---------- quiz ----------
  function buildMCQ(text, n=6) {
    const sents = splitSentences(text).filter(s => s.length > 40);
    const qs = [];
    for (const s of sents.slice(0, n*2)) {
      const words = s.split(/\s+/);
      const cand = words.filter(w => /^[A-Za-z][A-Za-z\-]{4,}$/.test(w));
      if (cand.length < 3) continue;
      const answer = cand[Math.floor(Math.random()*cand.length)];
      const stem = s.replace(answer, '____');
      // distractors
      const bag = sents.join(' ').split(/\W+/).filter(x => x && x !== answer);
      const uniq = Array.from(new Set(bag.filter(w => w.length>=4))).slice(0, 500);
      const opt = [answer];
      while (opt.length < 4 && uniq.length) {
        const w = uniq[Math.floor(Math.random()*uniq.length)];
        if (!opt.includes(w)) opt.push(w);
      }
      qs.push({ stem, options: shuffle(opt), answer });
      if (qs.length >= n) break;
    }
    if (!qs.length) return 'Not enough material for MCQ. Try another file.';
    return qs.map((q,i)=> {
      const letters = ['A','B','C','D'];
      const opts = q.options.map((o,j)=>`   ${letters[j]}. ${o}`).join('\n');
      const ans = letters[q.options.indexOf(q.answer)];
      return `${i+1}) ${q.stem}\n${opts}\n   Answer: ${ans}\n`;
    }).join('\n');
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a }

  // ---------- wire UI ----------
  function wire() {
    // initial
    $('#studentName').value = state.student;
    $('#libCollection').textContent = state.collection;
    $('#voiceSelect').value = state.voiceLang;
    renderLib();

    $('#saveName').addEventListener('click', () => {
      state.student = $('#studentName').value.trim();
      localStorage.setItem('ssc_student', state.student);
    });
    $('#setCollection').addEventListener('click', () => {
      state.collection = $('#collection').value;
      localStorage.setItem('ssc_collection', state.collection);
      renderLib();
    });
    $('#voiceSelect').addEventListener('change', () => {
      state.voiceLang = $('#voiceSelect').value;
      localStorage.setItem('ssc_voice', state.voiceLang);
    });
    $('#enableTTS').addEventListener('click', () => {
      speak(greetText()); // warm up
    });

    // uploads
    $('#fileInput').addEventListener('change', async (ev) => {
      const files = Array.from(ev.target.files || []);
      if (!files.length) return;
      // process sequentially to control memory
      for (const f of files) {
        const newItems = await routeFile(f);
        if (newItems && newItems.length) state.items.push(...newItems);
        renderLib();
        saveJSON('ssc_items', state.items);
      }
      $('#fileInput').value = '';
    });

    $('#clearLib').addEventListener('click', () => {
      if (!confirm('Clear all loaded items?')) return;
      state.items = []; saveJSON('ssc_items', state.items); renderLib();
    });

    // actions
    $('#doSummaryQuick').addEventListener('click', () => runOnSelection(t => summaryQuick(t)));
    $('#doSummaryDetailed').addEventListener('click', () => runOnSelection(t => summaryDetailed(t)));
    $('#doQuiz').addEventListener('click', () => runOnSelection(t => buildMCQ(t, 8)));
    $('#readAloud').addEventListener('click', () => speak($('#outBox').value.slice(0, 1800)));
    $('#copyOut').addEventListener('click', async () => {
      await navigator.clipboard.writeText($('#outBox').value || '');
    });

    // voices
    if ('speechSynthesis' in window) {
      const refreshVoices = () => {
        state.voices = window.speechSynthesis.getVoices();
      };
      refreshVoices();
      window.speechSynthesis.onvoiceschanged = refreshVoices;
      // auto-welcome
      setTimeout(() => speak(greetText()), 600);
    }
  }

  function runOnSelection(fn) {
    let target = null;
    if (state.selectionIndex != null) target = state.items[state.selectionIndex];
    else if (state.items.length) target = state.items[0];
    if (!target) { alert('Add files first, then click a row to select it.'); return; }
    const out = fn(target.text);
    $('#outBox').value = out;
  }

  function greetText() {
    const n = state.student || 'Student';
    switch (state.voiceLang) {
      case 'hi-IN': return `नमस्ते ${n}! स्मार्ट स्टडी कम्पैनियन में आपका स्वागत है। चलिए शुरू करते हैं!`;
      case 'mr-IN': return `नमस्कार ${n}! स्मार्ट स्टडी कम्पॅनियन मध्ये तुमचे स्वागत आहे. सुरू करू या!`;
      default:      return `Hello ${n}! Welcome to SmartStudy Companion. Let's begin.`;
    }
  }

  // boot
  wire();
})();